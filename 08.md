Voici un tutoriel corrigÃ© pas Ã  pas pour installer un Elasticsearch et un Kibana fonctionnels en versionÂ 8.19.5 via DockerÂ Compose, sans avoir Ã  saisir de mot de passe dans chaque commande.

Le problÃ¨me rencontrÃ© vient principalement de trois points :

1. **Variable `ES_JAVA_OPTS` mal citÃ©e**Â : sans guillemets, elle est interprÃ©tÃ©e comme une commande (`-Xmx1g: command not found`).
2. **Absence de dÃ©sactivation du seuil â€œflood stageâ€**Â : avec un disque presque plein, lâ€™index `.security` devient en lecture seule, ce qui empÃªche dâ€™authentifier les comptes (erreurs 401).
3. **Utilisation erronÃ©e ou jetons invalides** : les service tokens doivent Ãªtre crÃ©Ã©s une fois Elasticsearch prÃªt et stockÃ©s dans `.env`.

---

## 1. PrÃ©parer le dossier et le fichierÂ `.env`

CrÃ©ez votre rÃ©pertoire et le fichier `.env` en veillant bien Ã  **citer** les options mÃ©moire :

```bash
mkdir -p elk-dev && cd elk-dev

cat > .env <<'ENV'
STACK_VERSION=8.19.5
# mot de passe du superâ€‘utilisateur 'elastic'
ELASTIC_PASSWORD=changeme123!
# Les guillemets simples sont OBLIGATOIRES pour Ã©viter l'erreur -Xmx1g: command not found
ES_JAVA_OPTS='-Xms1g -Xmx1g'

# ClÃ©s dâ€™encryption pour Kibana (32 caractÃ¨res mini chacune)
KIBANA_ENCRYPTION_KEY1=change_me_to_a_very_long_random_string_key_1_________
KIBANA_ENCRYPTION_KEY2=change_me_to_a_very_long_random_string_key_2_________
KIBANA_ENCRYPTION_KEY3=change_me_to_a_very_long_random_string_key_3_________

# Le jeton de service Kibana sera ajoutÃ© automatiquement plus basÂ :
# ELASTICSEARCH_SERVICEACCOUNTTOKEN=
ENV
```

Vous nâ€™aurez plus Ã  taper le mot de passe dans vos commandes si vous chargez le `.env` :

```bash
set -a
source .env
set +a
```

---

## 2. CrÃ©er un `docker-compose.yml` propre

Assurezâ€‘vous que votre `docker-compose.yml` :

* **Ne mentionne pas** de nom dâ€™utilisateur/mot de passe pour Kibana.
* Active la sÃ©curitÃ© mais **dÃ©sactive les seuils disque** pour Ã©viter que les indices systÃ¨me passent en lecture seule (ce qui casse lâ€™authentification).

Voici un exemple prÃªt Ã  lâ€™emploi :

```yaml
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${STACK_VERSION}
    container_name: es01
    restart: unless-stopped
    environment:
      - node.name=es01
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - ES_JAVA_OPTS=${ES_JAVA_OPTS}
      # dÃ©sactive le blocage flood-stage (utile en VM avec peu d'espace)
      - cluster.routing.allocation.disk.threshold_enabled=false
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -s -u elastic:${ELASTIC_PASSWORD} http://localhost:9200 >/dev/null" ]
      interval: 10s
      timeout: 5s
      retries: 30

  kibana:
    image: docker.elastic.co/kibana/kibana:${STACK_VERSION}
    container_name: kib01
    restart: unless-stopped
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      - SERVER_NAME=kibana
      - SERVER_HOST=0.0.0.0
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      # Jeton de service ajoutÃ© dans .env aprÃ¨s gÃ©nÃ©ration
      - ELASTICSEARCH_SERVICEACCOUNTTOKEN=${ELASTICSEARCH_SERVICEACCOUNTTOKEN}
      - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=${KIBANA_ENCRYPTION_KEY1}
      - XPACK_REPORTING_ENCRYPTIONKEY=${KIBANA_ENCRYPTION_KEY2}
      - XPACK_SECURITY_ENCRYPTIONKEY=${KIBANA_ENCRYPTION_KEY3}
    ports:
      - "5601:5601"
    healthcheck:
      test: [ "CMD-SHELL", "curl -s http://localhost:5601/api/status | grep -q 'available' || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 30

volumes:
  es-data:
```

**Important :** Kibana ne doit plus utiliser lâ€™utilisateur `elastic` pour se connecter Ã  Elasticsearch. Le message dâ€™erreur Â«Â value of "elastic" is forbiddenÂ Â» indique que lâ€™utilisateur superâ€‘admin ne peut pas Ã©crire dans les indices systÃ¨me et quâ€™il faut un service token.

---

## 3. RÃ©initialiser complÃ¨tement et dÃ©marrer Elasticsearch

Pour que le nouveau mot de passe soit pris en compte et que lâ€™index `.security` soit sain, supprimez lâ€™ancien volume et redÃ©marrez :

```bash
# ArrÃªte et supprime les conteneurs + volumes
docker compose down -v

# S'assurer qu'il ne reste aucun processus sur 9200/5601 (optionnel)
sudo ss -ltnp | egrep ':(9200|5601)\b' || echo "OK: ports libres"

# DÃ©marre seulement Elasticsearch
docker compose up -d elasticsearch

# Attendre qu'Elasticsearch soit healthy
echo "Attente qu'Elasticsearch soit healthyâ€¦"
until [ "$(docker inspect -f '{{.State.Health.Status}}' es01)" = "healthy" ]; do sleep 2; done
```

---

## 4. GÃ©nÃ©rer et enregistrer le service token

1. GÃ©nÃ©rez un jeton unique pour le compte de service `elastic/kibana` **une fois quâ€™Elasticsearch est opÃ©rationnel** :

   ```bash
   NEW_TOKEN=$(docker exec es01 bash -lc \
     "/usr/share/elasticsearch/bin/elasticsearch-service-tokens create elastic/kibana kibana-$(date +%s)" \
     | awk -F'= ' '/= /{print $2}' | tr -d '\r')

   echo "Jeton gÃ©nÃ©rÃ© : ${NEW_TOKEN:0:15}..."
   ```

2. VÃ©rifiez que le jeton fonctionne :

   ```bash
   curl -s -H "Authorization: Bearer $NEW_TOKEN" http://localhost:9200/_security/_authenticate?pretty
   ```

   La rÃ©ponse doit contenir `"username" : "elastic/kibana"`.

3. Mettez-le dans `.env` :

   ```bash
   if grep -q '^ELASTICSEARCH_SERVICEACCOUNTTOKEN=' .env; then
     sed -i "s|^ELASTICSEARCH_SERVICEACCOUNTTOKEN=.*|ELASTICSEARCH_SERVICEACCOUNTTOKEN=$NEW_TOKEN|" .env
   else
     echo "ELASTICSEARCH_SERVICEACCOUNTTOKEN=$NEW_TOKEN" >> .env
   fi
   ```

Recharger `.env` dans votre shell (si nÃ©cessaire) :

```bash
set -a; source .env; set +a
```

---

## 5. DÃ©marrer Kibana

```bash
docker compose up -d kibana
```

Kibana lira automatiquement le jeton pour se connecter Ã  Elasticsearch. Suivez son statut :

```bash
# doit renvoyer "available" aprÃ¨s quelques instants
curl -s http://localhost:5601/api/status | jq -r '.status.overall.level'
```

Vous pourrez ensuite ouvrir `http://localhost:5601` et vous connecter avec lâ€™utilisateur `elastic` et le mot de passe `ELASTIC_PASSWORD` (celui du `.env`).

---

## 6. Utiliser les commandes cURL sans mot de passe manuel

AprÃ¨s avoir chargÃ© `.env` dans votre session, utilisez :

```bash
# Infos cluster
curl -u elastic:$ELASTIC_PASSWORD http://localhost:9200/

# Liste des indices (il nâ€™y aura rien immÃ©diatement aprÃ¨s lâ€™installation)
curl -u elastic:$ELASTIC_PASSWORD "http://localhost:9200/_cat/indices?v"
```

---

## 7. RÃ©sumÃ© des bonnes pratiques

* **Quotez `ES_JAVA_OPTS` dans `.env`** pour Ã©viter lâ€™erreur de commande `-Xmx1g`.
* **DÃ©sactivez les seuils disque** en dÃ©veloppement si votre disque est presque plein : sans cela, Elasticsearch place les indices en lecture seule Ã  partir de 95â€¯% dâ€™occupation.
* **Utilisez un service token** pour Kibana â€“ lâ€™utilisateur `elastic` est interdit pour cela.
* **Rechargez `.env` dans chaque nouveau shell** (`set -a; source .env; set +a`) pour que `$ELASTIC_PASSWORD` et le jeton soient disponibles dans vos commandes.

En suivant ces Ã©tapes, vous obtiendrez un dÃ©ploiement propre oÃ¹ Elasticsearch et Kibana fonctionnent ensemble, sans avoir Ã  saisir votre mot de passe dans les commandes.
















Câ€™est tout simple ðŸ™‚

**Username :** `elastic`
**Password :** la valeur de `ELASTIC_PASSWORD` dans ton fichier `.env`.

Dâ€™aprÃ¨s ce que tu as mis plus haut, câ€™est **`changeme123!`** (sauf si tu lâ€™as modifiÃ©e depuis).

Tu peux vÃ©rifier rapidement dans ton dossier `elk-dev` :

```bash
grep '^ELASTIC_PASSWORD=' .env
```

Si la connexion Ã©choue :

* assure-toi que tu nâ€™as pas dâ€™espace en trop et que la casse est correcte ;
* que Kibana est bien sur `http://localhost:5601` et quâ€™Elasticsearch rÃ©pond (`curl -u elastic:$ELASTIC_PASSWORD http://localhost:9200/`).

