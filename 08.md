## 1) Dossier et fichier `.env`

Créez le répertoire de travail et placez‑y un fichier `.env` qui contiendra toutes vos variables sensibles :

```bash
mkdir elk-dev && cd elk-dev

cat > .env <<'ENV'
STACK_VERSION=8.19.5
ELASTIC_PASSWORD=changeme123!
# Limites mémoire confortables pour une petite VM
ES_JAVA_OPTS=-Xms1g -Xmx1g
KIBANA_ENCRYPTION_KEY1=change_me_to_a_very_long_random_string_key_1_________
KIBANA_ENCRYPTION_KEY2=change_me_to_a_very_long_random_string_key_2_________
KIBANA_ENCRYPTION_KEY3=change_me_to_a_very_long_random_string_key_3_________
# Le service token Kibana sera ajouté automatiquement plus bas :
# ELASTICSEARCH_SERVICEACCOUNTTOKEN=
ENV
```

Ensuite, **chargez ces variables dans votre shell** pour éviter d’avoir à taper le mot de passe dans chaque commande :

```bash
set -a            # exporte automatiquement les variables lues
source .env       # charge le contenu de .env dans l’environnement
set +a
```

Dorénavant, la variable `$ELASTIC_PASSWORD` est disponible pour vos commandes cURL. Par exemple :

```bash
curl -u elastic:$ELASTIC_PASSWORD http://localhost:9200/
```

---

## 2) `docker-compose.yml` (sécurité activée, HTTP sans TLS)

Votre fichier `docker-compose.yml` doit référencer uniquement les variables de `.env` :

```yaml
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${STACK_VERSION}
    container_name: es01
    environment:
      - node.name=es01
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - ES_JAVA_OPTS=${ES_JAVA_OPTS}
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -s -u elastic:${ELASTIC_PASSWORD} http://localhost:9200 >/dev/null" ]
      interval: 10s
      timeout: 5s
      retries: 30

  kibana:
    image: docker.elastic.co/kibana/kibana:${STACK_VERSION}
    container_name: kib01
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      - SERVER_NAME=kibana
      - SERVER_HOST=0.0.0.0
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      # Kibana se connecte à ES via un service token (pas d’utilisateur super‑admin)
      - ELASTICSEARCH_SERVICEACCOUNTTOKEN=${ELASTICSEARCH_SERVICEACCOUNTTOKEN}
      - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=${KIBANA_ENCRYPTION_KEY1}
      - XPACK_REPORTING_ENCRYPTIONKEY=${KIBANA_ENCRYPTION_KEY2}
      - XPACK_SECURITY_ENCRYPTIONKEY=${KIBANA_ENCRYPTION_KEY3}
    ports:
      - "5601:5601"
    healthcheck:
      test: [ "CMD-SHELL", "curl -s http://localhost:5601/api/status | grep -q 'available' || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 30

volumes:
  es-data:
```

---

## 3) Script d’auto‑setup (génération du service token)

Démarrez Elasticsearch, générez automatiquement un service token pour Kibana, ajoutez‑le à `.env`, puis démarrez Kibana :

```bash
# Démarrer ES seul
docker compose up -d elasticsearch
echo "Attente qu'Elasticsearch soit healthy…"
until [ "$(docker inspect -f '{{.State.Health.Status}}' es01)" = "healthy" ]; do sleep 2; done

# Créer un service token pour Kibana et l'enregistrer dans .env
TOKEN=$(docker exec es01 bash -lc "/usr/share/elasticsearch/bin/elasticsearch-service-tokens create elastic/kibana kibana-token" | awk -F'= ' '/= /{print $2}' | tr -d '\r')
if grep -q '^ELASTICSEARCH_SERVICEACCOUNTTOKEN=' .env; then
  sed -i "s|^ELASTICSEARCH_SERVICEACCOUNTTOKEN=.*|ELASTICSEARCH_SERVICEACCOUNTTOKEN=$TOKEN|" .env
else
  echo "ELASTICSEARCH_SERVICEACCOUNTTOKEN=$TOKEN" >> .env
fi
echo "Service token injecté dans .env"

# Recharger les variables d'environnement
source .env

# Démarrer Kibana
docker compose up -d kibana
docker compose logs -f kibana
```

Une fois les conteneurs démarrés, vous pouvez accéder à :

* **Elasticsearch** via `http://localhost:9200` en utilisant le mot de passe stocké dans `.env`.
* **Kibana** via `http://localhost:5601`. Vous devrez toujours vous authentifier dans l’interface web avec l’utilisateur `elastic` et le mot de passe stocké dans `.env` (Kibana ne peut pas lire votre `.env` pour préremplir la page de connexion).

---

## 4) Éviter d’entrer le mot de passe dans vos commandes

Comme indiqué ci‑dessus, après avoir chargé le `.env` dans votre session, utilisez les variables directement :

```bash
# Informations sur le cluster
curl -u elastic:$ELASTIC_PASSWORD http://localhost:9200/

# Lister les indices
curl -u elastic:$ELASTIC_PASSWORD "http://localhost:9200/_cat/indices?v"
```

De cette façon, vous ne tapez plus de mot de passe.

---

## 5) Peut‑on supprimer totalement la page de login ?

Deux approches existent, mais elles ont des implications :

1. **Désactiver complètement la sécurité (`xpack.security.enabled=false`)** sur Elasticsearch et Kibana. Cela supprime toute authentification (même dans l’UI), pratique pour un laboratoire local mais pas recommandé pour un environnement accessible.
   Un article montre comment faire cela pour accéder à Kibana sans authentification en développement.
   Attention : même avec la sécurité désactivée, Kibana nécessite que certaines variables (`elasticsearch.hosts`) soient configurées pour éviter l’enrollment token.

2. **Activer l’authentification anonyme**, qui permet d’assigner un rôle à un “utilisateur” anonyme et de se connecter sans mot de passe. Cela se configure dans `elasticsearch.yml` en définissant un bloc `xpack.security.authc.anonymous` avec un nom d’utilisateur et des rôles. Il faut ensuite créer ces rôles et éventuellement ajuster Kibana pour qu’il les accepte. Cette option est plus complexe et réservée à des cas précis.

Dans votre cas, la méthode la plus simple consiste à conserver la sécurité activée (avec le token pour Kibana) et à ne plus saisir les mots de passe manuellement grâce à l’utilisation de variables d’environnement.

---

### Références

* Pour accéder à Kibana sans authentification, on peut désactiver `xpack.security.enabled` – utile en environnement de test.
* Elastic recommande d’utiliser l’authentification anonyme pour intégrer des dashboards ou donner un accès sans mot de passe, en configurant un utilisateur anonyme avec des rôles.
* Si la sécurité est désactivée, Kibana ne nécessite pas d’enrollment token ; il suffit de définir correctement `elasticsearch.hosts`.
